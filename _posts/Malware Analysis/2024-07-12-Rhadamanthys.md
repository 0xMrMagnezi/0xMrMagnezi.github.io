---
title: "Malware Analysis - Rhadamanthys"
classes: wide
header:
  teaser: /assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/Rhada.png
ribbon: navy
description: "Rhadamanthys Malware Analysis"
categories:
  - Malware Analysis
tags:
  - Trojan
  - RAT
  - Worm
toc: true
---
Sample:
```
fb6402d3ef1fcdd5af327668fa8d41b4
```

# Background
Rhadamanthys malware has been notably associated with the threat actor group known as Sandworm.
Sandworm, believed to have ties to Russian intelligence, It allows them to gain unauthorized access to computers, enabling them to execute commands, steal data, and surveil victims through webcams and microphones.
It spreads via phishing emails and exploits software vulnerabilities.

# Static Analysis - Stage 1
<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/malware bazaar.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 1: Malware Bazaar Entry</sub>
</div>
<br>

The first stage contained a relatively short PowerShell script that was somewhat obfuscated, as shown in Figure 2.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/obf ps.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 2: Obfuscated PowerShell</sub>
</div>
<br>

After cleaning up the code and deobfuscating it, we were left with clear code, as shown in Figures 3 and 4.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/after cleaning.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 3: After Cleaning</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/using the replaces found 2 urls.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 4: After Deobfuscation</sub>
</div>
<br>

The first URL downloads a PDF and opens it, while the second URL downloads a VBS file and executes it in the background.
Browsing to this URL revealed a lengthy, obfuscated VBS script.

# Second Stage

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/browsing the site reveals long vbs.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 5: Long VBS Script</sub>
</div>
<br>

After examining the code, I uncovered clues about the obfuscation technique employed.
The method involved filling the code with junk code, and in the middle of the script, a long string was constructed.
Once I identified the execution point, I disarmed it and echoed the final command to the console using CScript.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/modify, output using cscript.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 6: CScript Output</sub>
</div>
<br>

After cleaning up the code, I discovered an important function that functions similarly to a regex.
This 'regex' essentially counts every sixth character and concatenates them into a new string.
In Figure 7 you can find that specific function.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/cleaning the code reveals main function regex looklike2.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 7: Regex Function</sub>
</div>
<br>

Understanding that function led me to construct a regex in CyberChef, through which I successfully extracted the next stage of the malware.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/building regex in cyberchef, 2 urls.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 8: Regex in CyberChef</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/cleaning the code reveals main function regex looklike3.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 9: After Decoidng the Whole code</sub>
</div>
<br>

As indicated in Figure 8 and 9, two URLs have been identified containing the next stage of the malware.

# Third Stage

Browsing to those URLs revealed the next stage along with additional files containing other variants as shown in Figure 10 and 11.


<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/1st url long obf.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 10: First URL</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/2nd url - 3 hosted files.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 11: Second URL - Revealed 3 variants</sub>
</div>
<br>

The content of the file was loaded into the previous script and decoded from Base64.
Using CyberChef, I decoded the Base64 content of the file. At the end of the file, the actual code was revealed, as shown in Figure 11.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/hhk from base64.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 12: CyberChef Base64 Decode</sub>
</div>
<br>

This part also utilized the previously analyzed regex function.
Using the same technique to decode a new function was revealed.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/finding xor function.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 13: XOR Function Revealed</sub>
</div>
<br>

After analyzing this function, I discovered that it utilized XOR with the key 84 in Hex an example.
An be found in figure 14.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/using cyberchef to xor.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 14: Using XOR</sub>
</div>
<br>

Before Decoding:

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/before xor.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 15: Before XOR</sub>
</div>
<br>

After Decoding:

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/after xor.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 16: After XOR</sub>
</div>
<br>

That stage revealed memory manipulation and code injection techniques.

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/proc_tree.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 17: Process Tree Using Procmon</sub>
</div>
<br>


# Network Analysis

Using Wireshark and Fiddler I was able to extract Network IOC's:

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/dns requests.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 18: Wireshark DNS Requests</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/fiddler.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 19: Fiddler Output</sub>
</div>
<br>

# Virus Total

<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/VT URL.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 20: VT Url</sub>
</div>
<br>


<div style="text-align: center;">
    <img src="/assets/images/2024-07-09-MalwareAnalysis_Rhadamanthus/VT URL2.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 21: VT Url</sub>
</div>
<br>

# IOCs

- Hash:
```
41961596aa91e91c8e4415cff137b345
4555c60872fad83c47c29b2052c978fd
d298368760f646f852027f697df07ee6
fb6402d3ef1fcdd5af327668fa8d41b4
05ed7b3d821af8e38b861b21ad567c1d
```
- URL:
```
kuthbaneng[.]com
pineappletech[.]ae
almrwad[.]com
```
- IP:
```
184[.]171[.]244[.]231
103[.]21[.]59[.]27
91[.]195[.]240[.]94
```



