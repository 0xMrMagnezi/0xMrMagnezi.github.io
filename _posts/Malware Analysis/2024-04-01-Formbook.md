---
title: "Malware Analysis - FormBook"
classes: wide
header:
  teaser: /assets/images/2024-04-01-MalwareAnalysis_Formbook/1.jpg
ribbon: navy
description: "Formbook Analysis and Configuration Extraction"
categories:
  - Malware Analysis
tags:
  - Trojan
  - Bot
  - .NET
  - CyberChef
toc: true
---
Sample:
```
2effd68ca29fb310fbe40749eb566d0e
```

# Background
Formbook is a type of malware that specializes in stealing sensitive information from infected systems, 
primarily focusing on capturing keystrokes, clipboard data, and form data from web browsers.

# Static Analysis
<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/Database entry.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 1: Malware Bazaar Entry</sub>
</div>
<br>

After downloading and extracting the .bat file, we observed a relatively simple obfuscation technique — Base64 encoding. 
At the end, there was a large chunk of code that appeared to be a file.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/obfuscated stage 1.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 2: Obfuscated code</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/obfuscated chunk code.png" alt="Screenshot1" />
    <br>
    <sub>Figure 3: Chunk code</sub>
</div>
<br>

Upon examining Figure 2, it became evident that the data resembled a straightforward Base64 encoded string. 
Utilizing CyberChef, I proceeded with the decoding process.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/decoding obfuscated stage 1 from base64.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 4: Using CyberChef to decode</sub>
</div>
<br>

Repeating this process now reveals readable code.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/decoded stage 1.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 5: After Decoding</sub>
</div>
<br>

In the decoded code, we can already observe some manipulation using decompression and reversal. 
Therefore, I decided to use this technique on the code at the end of the script, as shown in Figure 6.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/Getting the new exe file.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 6: Extracting EXE file form the .bat code</sub>
</div>
<br>

# Second Stage

After extracting the new EXE file, I used DIE and found that it is written in .NET, which means we can further investigate it using DNSpy.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/DIE on output bin.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 7: DIE on the output from CyberChef</sub>
</div>
<br>

While debugging the new file, it was observed that a new array is being created and used. 
This array had the magic header ‘4D5A’, which indicates the presence of another new EXE file that is being used or created, as shown in Figure 8.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/seeing 4D5A on array - new exe.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 8: Showing The Array that starts with “4D5A”</sub>
</div>
<br>

# Third Stage

After further analysis, it was seen that there were actually two files (arrays) being created with this header. 
I decided to dump those arrays to new files for further investigation.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/DIE on array1.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 9: Written in .NET and Obfuscated and packed using Obfuscator</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/DIE on array2.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 10: Written in .NET and is DLL</sub>
</div>
<br>

We can use PEStudio for quick and precise analysis. As shown in Figure 11 + 12, we can see that we are dealing with the actual malware and its DLL.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/PEstudio on array1 - the mal dll.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 11: Using PEstudio on DLL</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/PEstudio on array2 - the mal exe.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 12: Using PEstudio on the second file</sub>
</div>
<br>

While debugging this new and final staged malware, it was observed that it is using a lot of keylogging techniques and sending information to the attacker. 
For example, system information and public IP are being sent, as shown in the next Figures.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/DNSPY array2 - get computer information.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 13: Sending Computer Information</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/DNSPY array2 - request to get public IP.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 14: Sending Public IP</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/DNSPY array2 - keylogger and screen logger.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 15: Keylogger & Screenlogger</sub>
</div>
<br>

# Extracting Malware Configuration

At the end, I managed to extract the malware configuration, as shown in Figure 16. 
These details are essential for the malware to work properly and contain sensitive data such as Smtp sender, receiver and password.

<div style="text-align: center;">
    <img src="/assets/images/2024-04-01-MalwareAnalysis_Formbook/Malware config.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 16: Malware Configuration</sub>
</div>
<br>

# Summary

In summary, Formbook is a powerful malware focused on data theft through keylogging and information exfiltration. 
My analysis revealed its obfuscation methods, exposing a .NET-based executable that deploys the malware and its DLL. 
Furthermore, I successfully extracted the malware’s configuration.

# IOCs

- Hash:
```
2effd68ca29fb310fbe40749eb566d0e
56e3f56dda234344fb2799c10727e642
f362f6f1dd0d9521752008cb1789a699
cbd924de2846331d88a342757c53fe08
```
- URL
```
hxxps://api[.]ipify[.]org
mail[.]agagroup[.]lv
```
- Email
```
remiset@remisat[.]com[.]uy
info@agagroup[.]lv
```
