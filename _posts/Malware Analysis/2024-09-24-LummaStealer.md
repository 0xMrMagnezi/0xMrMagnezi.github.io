---
title: "Malware Analysis - Lumma Stealer"
classes: wide
header:
  teaser: /assets/images/2024-09-24-MalwareAnalysis_LummaStealer/image2.png
ribbon: navy
description: "Lumma Stealer Malware Analysis"
categories:
  - Malware Analysis
tags:
  - Trojan
  - Keylogger
  - Phishing
toc: true
---
Sample:
```
https://ch3[.]dlvideosfre[.]click/human-verify-system[.]html
```

# Background
Lumma Stealer (aka LummaC2 Stealer) is an information stealer that has been available through a Malware-as-a-Service (MaaS) model on Russian-speaking forums since at least August 2022.
Once the targeted data is obtained, it is exfiltrated to a C2 server.


# Static Analysis - Stage 1
This relatively new phishing technique, known as 'self-pawn,' uses social engineering to lure users into executing malicious commands by prompting them to click 'I'm not a robot as shown in Figure 1.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/first page.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 1: I'm not a robots button</sub>
</div>
<br>

After pressing the button, it instructs the user to use the Run feature in Windows.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/lures_user_to run_the_code.PNG
" alt="Screenshot1" />
    <br>
    <sub>Figure 2: After Pressing The Button</sub>
</div>
<br>

After further inspection and using F12 to view the page source, I found a script section that contained Powershell code, as shown in Figure 2.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/pressing f12 shows ps code.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 3: F12 To View Page Source</sub>
</div>
<br>

Then, I took the Base64-encoded string and decoded it using CyberChef. 
The output was a 'mshta' command that pointed to a new URL.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/decodes the base64 string shows new url.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 4: CyberChef Decoding</sub>
</div>
<br>

As shown in Figure 4, I used curl to download the file it attempts to run.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/downloading the new stage.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 5: Curling To The New URL</sub>
</div>
<br>

# Static Analysis - Stage 2

After downloading the file, I conducted basic triage and static analysis on it.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/DIE on outbin.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 6: Using Detect It Easy</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/pestudio keylogger functions.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 7: Using PEStudio</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/capa on outbin.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 8: Using CAPA To Find Capabilities</sub>
</div>
<br>

This part made me suspicious that there was much more in the executable than I initially noticed. Using the strings command, I found one extremely large string. 
With a hex editor, I was able to locate it, as shown in Figure 9. 

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/using hxd we can see script tag.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 9: Using HxD</sub>
</div>
<br>

As marked in Figure 9, it contained a "script" tag. 
This script was extracted for further investigation.

This script used a relatively simple obfuscation technique that replaced strings with characters and then converted them using the fromCharCode function.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/seeing the script in notepad.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 10: Marking The Critical Replacement</sub>
</div>
<br>

For the next part, I wrote a simple PowerShell script to output what this function executes, without the risk of it being executed.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/After cleaning the script - get the output using ps.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 11: PS Script To Print The Output</sub>
</div>
<br>

Using this script, I was able to print the executed code to the console. 
It appears to be another layer of obfuscated code that requires further investigation.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/print output using powershell.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 12: Output Of The PS To The Console</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/After cleaning js code.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 13: Cleaned JS Code</sub>
</div>
<br>

As marked in Figure 13, this is the function being used for decoding.
After understanding the code, I disarmed it and used WScript.Echo to print the output to the console.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/disarming the code and output the content.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 13: Disarmed Code With Echo</sub>
</div>
<br>

I used CScript to output the contents of the two variables.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/using cscript to output the js deobfuscated.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 14: Output Using CScript</sub>
</div>
<br>

The output was copied to Notepad for further investigation and to make sense of the code.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/after cleaning ps script outputed from js.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 15: Cleaned PS Script</sub>
</div>
<br>

As marked in Figure 15, AES cryptography is applied to the 'fALRGP' variable.
I used CyberChef to decrypt this variable using the provided Key and IV.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/using cyberchef with aes decrypt on the ps.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 16: CyberChef Recipe</sub>
</div>
<br>

The output from CyberChef was another obfuscated PowerShell code.
The script was modified slightly and disarmed to output three key variables.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/inside the ps was important function - took it and output the deob.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 17: Modified PS Code</sub>
</div>
<br>

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/output of the deob of the ps outputs 2 zip files.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 18: Output Of The Modified PS Code</sub>
</div>
<br>

# Static Analysis - Stage 3

Using the Curl command, I was able to download the two zip files for further inspection.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/downloading 2 zip files using curl.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 19: Using Curl</sub>
</div>
<br>

Inside the first zip file, there were five legitimate DLLs, while the second zip file contained a single EXE, which I focused on for analysis.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/pestudio new exe fallged imports.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 20: Using PEStudio</sub>
</div>
<br>

The output from PeStudio indicates that there may be some form of process injection due to the presence of VirtualAlloc.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/capa on last exe.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 21: Using CAPA</sub>
</div>
<br>

# Dynamic Analysis - Stage 3

While running the malware with ProcMon in the background, it was observed that, as suspected, the malware injects itself into 'BitLockerToGo.exe,' a legitimate file.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/process tree of VectirFree.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 22: Process Tree</sub>
</div>
<br>

In addition, as shown in Figure 23, there was a long sleep period of about 2 minutes after execution before the malware began its activity.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/showing in proc mon there is a long sleep before it start to do something.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 23: ProcMon Long Sleep Period</sub>
</div>
<br>

While running the malware in an isolated environment, numerous DNS requests to the attacker's C2 server were observed, as shown in Figure 24.

<div style="text-align: center;">
    <img src="/assets/images/2024-09-24-MalwareAnalysis_LummaStealer/dns query to attacker.PNG" alt="Screenshot1" />
    <br>
    <sub>Figure 24: Using WireShark To Capture Network Traffic</sub>
</div>
<br>

# IOCs

- Hash:
```
fea50d3bb695f6ccc5ca13834cdfe298
83ae58dd03f33d1fae6771e859200be6
7b1f43deed8fc7e35f8394548e12dd81
c39f64a31e9f15338f83411bb9fc0942
b832096cf669ff4d66e04b252cb1a1dc
```
- URL:
```
https://ch3[.]dlvideosfre[.]click/human-verify-system[.]html
https://verif[.]dlvideosfre[.]click/2ndhsoru
https://verif[.]dlvideosfre[.]click/K1[.]zip
https://verif[.]dlvideosfre[.]click/K2[.]zip
https://verif[.]dlvideosfre[.]click
celebratioopz[.]shop
steamcommunity[.]com
writerospzm[.]shop
deallerospfosu[.]shop
bassizcellskz[.]shop
mennyudosirso[.]shop
languagedscie[.]shop
complaintsipzzx[.]shop
quialitsuzoxm[.]shop
```


